# aws-sso-config-generator images

This is generated by [build-images-readme.exs](./build-images-readme.exs).

## aws-sso-config-generator - AWS SSO Authorization Code Flow with PKCE (Default)

More information on how this is implemented https://github.com/aws/aws-cli/commit/130005af5ea6a75705ed528aaf06d533f449bef9

```mermaid
sequenceDiagram
    title aws-sso-config-generator - AWS SSO Authorization Code Flow with PKCE (Default) - Source: https://github.com/djgoku/aws-sso-config-generator
    participant User
    participant CLIApp as aws-sso-config-generator
    participant LocalServer as Local Bandit Server
    participant AWSSSO as AWS SSO OIDC Service

    User->>+CLIApp: Runs command (no --device-code)
    CLIApp->>+LocalServer: Starts local server
    Note over CLIApp,LocalServer: The redirect_uri must be http://127.0.0.1:RANDOM_PORT/oauth/callback

    CLIApp->>+AWSSSO: 1. Registers client
    Note right of CLIApp: Params:<br/>- clientName: "aws-sso-config-generator"<br/>- clientType: "public"<br/>- grantTypes: ["authorization_code"]<br/>- redirectUris: ["http://127.0.0.1:RANDOM_PORT/oauth/callback"]<br/>- scopes: ["sso:account:access"]
    AWSSSO-->>-CLIApp: Returns client_id & client_secret

    CLIApp->>+AWSSSO: 2. Starts authorization
    AWSSSO-->>-CLIApp: Returns full authorize_url (with PKCE challenge)
    Note right of CLIApp: Note: The URL's region must match the SSO region.<br/>Sample URL:<br/>https://oidc.us-east-1.amazonaws.com/authorize?<br/>response_type=code<br/>&client_id=a1b2c3d4<br/>&redirect_uri=http%3A%2F%2F127.0.0.1%3A12345%2Foauth%2Fcallback<br/>&scope=sso%3Aaccount%3Aaccess<br/>&state=xyz123<br/>&code_challenge=E9Mel...<br/>&code_challenge_method=S256

    User->>+AWSSSO: Logs in, grants consent via browser
    AWSSSO->>-User: Redirects browser to the registered redirect_uri with an authorization code
    Note right of AWSSSO: The redirect path must be /oauth/callback.<br/>If not, the API may return InvalidRedirectUriException with error:<br/>"Requested client type must use loopback interface for redirect"
    Note right of AWSSSO: Source: https://github.com/djgoku/aws-sso-config-generator

    User->>+LocalServer: Browser hits the local redirect URI
    LocalServer->>-CLIApp: Captures authorization_code and signals completion
    deactivate LocalServer

    CLIApp->>+AWSSSO: 3. Exchanges code for token
    Note right of CLIApp: Params:<br/>- grant_type: "authorization_code"<br/>- client_id<br/>- client_secret<br/>- code<br/>- redirect_uri<br/>- (PKCE) code_verifier
    AWSSSO-->>-CLIApp: Returns access_token

    CLIApp->>User: Login successful, proceeds to generate config
```

## AWS CLI - AWS SSO Authorization Code Flow with PKCE (Default)

More information on how this is implemented https://github.com/aws/aws-cli/commit/130005af5ea6a75705ed528aaf06d533f449bef9

```mermaid
sequenceDiagram
    title AWS CLI - AWS SSO Authorization Code Flow with PKCE (Default) - Source: https://github.com/djgoku/aws-sso-config-generator
    participant User
    participant CLIApplication as CLI Application
    participant LocalWebServer as Local Web Server
    participant AWSSSO as AWS SSO OIDC Service

    User->>+CLIApplication: Initiates login
    CLIApplication->>+LocalWebServer: Starts local server
    Note over CLIApplication,LocalWebServer: The redirect_uri must be http://127.0.0.1:RANDOM_PORT/oauth/callback

    CLIApplication->>+AWSSSO: 1. Calls RegisterClient API
    Note right of CLIApplication: Params:<br/>- clientName: "my-cli-app"<br/>- clientType: "public"<br/>- grantTypes: ["authorization_code"]<br/>- redirectUris: ["http://127.0.0.1:RANDOM_PORT/oauth/callback"]<br/>- scopes: ["sso:account:access"]
    AWSSSO-->>-CLIApplication: Returns clientId & clientSecret

    CLIApplication->>User: Opens AWS SSO authorization URL in browser
    Note right of CLIApplication: Note: The URL's region must match the SSO region.<br/>Sample URL:<br/>https://oidc.us-east-1.amazonaws.com/authorize?<br/>response_type=code<br/>&client_id=a1b2c3d4<br/>&redirect_uri=http%3A%2F%2F127.0.0.1%3A12345%2Foauth%2Fcallback<br/>&scope=sso%3Aaccount%3Aaccess<br/>&state=xyz123<br/>&code_challenge=E9Mel...<br/>&code_challenge_method=S256

    User->>+AWSSSO: Authenticates via browser
    AWSSSO-->>-User: Redirects browser to the registered redirect_uri with an authorization code
    Note right of AWSSSO: The redirect path must be /oauth/callback.<br/>If not, the API may return InvalidRedirectUriException with error:<br/>"Requested client type must use loopback interface for redirect"
    Note right of AWSSSO: Source: https://github.com/djgoku/aws-sso-config-generator

    User->>+LocalWebServer: Browser is redirected to the local server
    LocalWebServer-->>-CLIApplication: Captures the authorization code
    deactivate LocalWebServer

    CLIApplication->>+AWSSSO: 2. Calls CreateToken API
    Note right of CLIApplication: Params:<br/>- grant_type: "authorization_code"<br/>- client_id<br/>- client_secret<br/>- code<br/>- redirect_uri<br/>- (PKCE) code_verifier
    AWSSSO-->>-CLIApplication: Returns access_token

    CLIApplication->>User: Login successful
```

## aws-sso-config-generator - AWS SSO Device Code Flow (with --device-code)

```mermaid
sequenceDiagram
    title aws-sso-config-generator - AWS SSO Device Code Flow (with --device-code) - Source: https://github.com/djgoku/aws-sso-config-generator
    participant User
    participant CLIApp as aws-sso-config-generator
    participant AWSSSO as AWS SSO OIDC Service

    User->>+CLIApp: Runs command with --device-code flag

    CLIApp->>+AWSSSO: 1. Registers client
    Note right of CLIApp: Params:<br/>- clientName: "aws-sso-config-generator"<br/>- clientType: "public"<br/>- grantTypes: ["urn:ietf:params:oauth:grant-type:device_code"]
    AWSSSO-->>-CLIApp: Returns client_id & client_secret

    CLIApp->>+AWSSSO: 2. Starts device authorization
    AWSSSO-->>-CLIApp: Returns device_code & verification_uri_complete

    CLIApp->>User: Displays verification URL and user code to console

    User->>+AWSSSO: Opens URL in a browser (on any device) and enters code/logs in

    CLIApp->>+AWSSSO: 3. Starts polling token endpoint
    Note right of CLIApp: Params:<br/>- grant_type: "urn:ietf:params:oauth:grant-type:device_code"<br/>- client_id<br/>- client_secret<br/>- device_code
    loop Until User Authenticates
        AWSSSO-->>-CLIApp: Responds "authorization_pending"
        CLIApp->>AWSSSO: Polls again after an interval
    end
    AWSSSO-->>-CLIApp: Returns access_token
    Note right of AWSSSO: More information atGitHub Source Link: https://github.com/djgoku/aws-sso-config-generator

    CLIApp->>User: Login successful, proceeds to generate config
```

## AWS CLI - AWS SSO Device Code Flow

```mermaid
sequenceDiagram
    title AWS SSO Device Code Flow - Source: https://github.com/djgoku/aws-sso-config-generator
    participant User
    participant CLIApplication as CLI Application
    participant AWSSSO as AWS SSO OIDC Service

    User->>+CLIApplication: Initiates login

    CLIApplication->>+AWSSSO: 1. Calls RegisterClient API
    Note right of CLIApplication: Params:<br/>- clientName: "my-cli-app"<br/>- clientType: "public"<br/>- grantTypes: ["urn:ietf:params:oauth:grant-type:device_code"]
    AWSSSO-->>-CLIApplication: Returns clientId & clientSecret

    CLIApplication->>+AWSSSO: 2. Calls StartDeviceAuthorization API
    AWSSSO-->>-CLIApplication: Returns deviceCode, verificationUri, and userCode

    CLIApplication->>User: Displays verificationUri and userCode in the terminal

    User->>+AWSSSO: Opens verificationUri in a browser (any device) and enters userCode

    CLIApplication->>+AWSSSO: 3. Begins polling CreateToken API
    Note right of CLIApplication: Params:<br/>- grant_type: "urn:ietf:params:oauth:grant-type:device_code"<br/>- client_id<br/>- client_secret<br/>- device_code
    loop Until User Authenticates or Timeout
        AWSSSO-->>-CLIApplication: Responds "authorization_pending"
        CLIApplication->>AWSSSO: Polls again after interval
    end
    AWSSSO-->>-CLIApplication: Returns access_token

    CLIApplication->>User: Login successful
```
